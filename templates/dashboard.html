{% extends "base.html" %}
{% block title %}–ü–∞–Ω–µ–ª—å{% endblock %}
{% block content %}

<h3 class="mb-3 text-light">–û–≥–ª—è–¥ –∑–∞ –º—ñ—Å—è—Ü—å</h3>
<p class="text-secondary">–ü–µ—Ä—ñ–æ–¥: {{ month }}</p>

<!-- –í–∏–±—ñ—Ä –º—ñ—Å—è—Ü—è —ñ —Ä–æ–∫—É -->
<form method="get" action="{{ url_for('dashboard') }}" class="row g-2 mb-4">
  <div class="col-md-4">
    <label class="form-label text-light">–í–∏–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥</label>
    <div class="d-flex gap-2">
      {# –º—ñ—Å—è—Ü—å #}
      <select name="month" class="form-select bg-dark text-light">
        {% for m_num, m_name in months %}
          <option value="{{ m_num }}" {% if m_num == selected_month %}selected{% endif %}>
            {{ m_name|capitalize }}
          </option>
        {% endfor %}
      </select>
      {# —Ä—ñ–∫ #}
      <select name="year" class="form-select bg-dark text-light">
        {% for y in years %}
          <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="col-md-2 d-flex align-items-end">
    <button class="btn btn-primary w-100" type="submit">–ü–æ–∫–∞–∑–∞—Ç–∏</button>
  </div>
</form>

<!-- –ö–ª—é—á–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card bg-dark border-0 p-3 shadow-sm h-100">
      <div class="text-white fw-semibold">–î–æ—Ö—ñ–¥</div>
      <div class="fs-4 mt-2 text-white">{{ currency }} {{ "%.2f"|format(income) }}</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-dark border-0 p-3 shadow-sm h-100">
      <div class="text-white fw-semibold">–í–∏—Ç—Ä–∞—Ç–∏</div>
      <div class="fs-4 mt-2 text-white">{{ currency }} {{ "%.2f"|format(expenses) }}</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-dark border-0 p-3 shadow-sm h-100">
      <div class="text-white fw-semibold">–ù–∞–∫–æ–ø–∏—á–µ–Ω–æ –≤ —Ü—ñ–ª—è—Ö</div>
      <div class="fs-4 mt-2 text-white">{{ currency }} {{ "%.2f"|format(goals_savings) }}</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-dark border-0 p-3 shadow-sm h-100">
      <div class="text-white fw-semibold">–ë–∞–ª–∞–Ω—Å –∑–∞ –ø–µ—Ä—ñ–æ–¥</div>
      <div class="fs-4 mt-2 text-white">{{ currency }} {{ "%.2f"|format(balance) }}</div>
    </div>
  </div>
</div>

<!-- –§—ñ–Ω–∞–Ω—Å–æ–≤–µ –∑–¥–æ—Ä–æ–≤‚Äô—è -->
<div class="mb-4">
  <div class="d-flex align-items-center gap-2 mb-2">
    <h6 class="text-light mb-0">–§—ñ–Ω–∞–Ω—Å–æ–≤–µ –∑–¥–æ—Ä–æ–≤‚Äô—è</h6>
    <!-- –ø—ñ–¥–∫–∞–∑–∫–∞ –ø—Ä–æ —Ñ–æ—Ä–º—É–ª—É -->
    <span
      class="text-secondary"
      style="cursor: pointer;"
      data-bs-toggle="tooltip"
      data-bs-placement="right"
      title="50% ‚Äî –≤–∏—Ç—Ä–∞—Ç–∏, 30% ‚Äî –±—é–¥–∂–µ—Ç, 20% ‚Äî —Ü—ñ–ª—ñ."
    >
      ‚ìò
    </span>
  </div>
  <div class="progress mb-2" style="height: 22px;">
    <div
      class="progress-bar {% if health >= 70 %}bg-success{% elif health >= 40 %}bg-warning{% else %}bg-danger{% endif %}"
      role="progressbar"
      style="width: {{ health }}%;"
      aria-valuenow="{{ health }}"
      aria-valuemin="0"
      aria-valuemax="100"
    >
      {{ "%.1f"|format(health) }}%
    </div>
  </div>
</div>

<!-- –î—ñ–∞–≥—Ä–∞–º–∏ -->
<div class="row g-4">
  <!-- –≤–∏—Ç—Ä–∞—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö -->
  <div class="col-md-6">
    <div class="card bg-dark border-0 p-3 shadow-sm h-100">
      <h6 class="text-light mb-3">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ç—Ä–∞—Ç –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏</h6>
      <canvas id="expenseChart" height="220"></canvas>
      {% if not exp_labels %}
        <p class="text-muted mt-2">–ù–µ–º–∞—î –≤–∏—Ç—Ä–∞—Ç —É —Ü—å–æ–º—É –ø–µ—Ä—ñ–æ–¥—ñ.</p>
      {% endif %}
    </div>
  </div>
  <!-- —Ä—É—Ö –∫–æ—à—Ç—ñ–≤ –ø–æ –¥–Ω—è—Ö -->
  <div class="col-md-6">
    <div class="card bg-dark border-0 p-3 shadow-sm h-100">
      <h6 class="text-light mb-3">–†—É—Ö –∫–æ—à—Ç—ñ–≤ –∑–∞ –¥–Ω—è–º–∏</h6>
      <canvas id="dailyChart" height="220"></canvas>
      {% if not daily_labels %}
        <p class="text-muted mt-2">–ù–µ–º–∞—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π —É —Ü—å–æ–º—É –ø–µ—Ä—ñ–æ–¥—ñ.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // –¥–∞–Ω—ñ –∑ –±–µ–∫–µ–Ω–¥–∞
  const expLabels = {{ exp_labels|tojson }};
  const expValues = {{ exp_values|tojson }};
  const dailyLabelsRaw = {{ daily_labels|tojson }};
  const dailyValues = {{ daily_values|tojson }};

  // YYYY-MM-DD -> "8 –ª–∏—Å—Ç–æ–ø–∞–¥–∞"
  function formatDateUkr(isoDate) {
    const months = [
      "—Å—ñ—á–Ω—è","–ª—é—Ç–æ–≥–æ","–±–µ—Ä–µ–∑–Ω—è","–∫–≤—ñ—Ç–Ω—è","—Ç—Ä–∞–≤–Ω—è","—á–µ—Ä–≤–Ω—è",
      "–ª–∏–ø–Ω—è","—Å–µ—Ä–ø–Ω—è","–≤–µ—Ä–µ—Å–Ω—è","–∂–æ–≤—Ç–Ω—è","–ª–∏—Å—Ç–æ–ø–∞–¥–∞","–≥—Ä—É–¥–Ω—è"
    ];
    const parts = isoDate.split("-");
    if (parts.length !== 3) return isoDate;
    const m = parseInt(parts[1], 10);
    const d = parseInt(parts[2], 10);
    if (isNaN(m) || isNaN(d)) return isoDate;
    return `${d} ${months[m - 1]}`;
  }

  // –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –¥–∞—Ç–∏ –¥–ª—è –ø—ñ–¥–ø–∏—Å—ñ–≤
  const dailyLabels = dailyLabelsRaw.map(formatDateUkr);

  // –±–∞–∑–æ–≤—ñ –∫–æ–ª—å–æ—Ä–∏
  const brightColors = [
    '#00bcd4', '#4caf50', '#ff9800',
    '#e91e63', '#9c27b0', '#ffcd56'
  ];

  //  –¥–æ–Ω–∞—Ç –ø–æ –≤–∏—Ç—Ä–∞—Ç–∞—Ö
  if (expLabels.length > 0) {
    const ctx1 = document.getElementById('expenseChart').getContext('2d');
    new Chart(ctx1, {
      type: 'doughnut',
      data: {
        labels: expLabels,
        datasets: [{
          data: expValues,
          backgroundColor: brightColors,
          borderColor: '#181a1b',
          borderWidth: 1
        }]
      },
      options: {
        plugins: {
          legend: {
            labels: { color: '#fff' }
          }
        }
      }
    });
  }

  // üîµ –ª—ñ–Ω—ñ—è –ø–æ –¥–Ω—è—Ö
  if (dailyLabels.length > 0) {
    const ctx2 = document.getElementById('dailyChart').getContext('2d');
    new Chart(ctx2, {
      type: 'line',
      data: {
        labels: dailyLabels,
        datasets: [{
          label: '–†—É—Ö –∫–æ—à—Ç—ñ–≤ –∑–∞ –¥–Ω—è–º–∏',
          data: dailyValues,
          borderColor: '#36a2eb',
          backgroundColor: 'rgba(54,162,235,0.2)',
          fill: true,
          tension: 0.3,
          pointRadius: 3,
          pointBackgroundColor: '#36a2eb'
        }]
      },
      options: {
        scales: {
          x: {
            ticks: { color: '#fff' },
            grid: { color: 'rgba(255,255,255,0.03)' }
          },
          y: {
            ticks: { color: '#fff' },
            grid: { color: 'rgba(255,255,255,0.03)' }
          }
        },
        plugins: {
          legend: { labels: { color: '#fff' } }
        }
      }
    });
  }

  // –∞–∫—Ç–∏–≤–∞—Ü—ñ—è tooltip'—ñ–≤ Bootstrap
  document.addEventListener('DOMContentLoaded', function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (el) {
      return new bootstrap.Tooltip(el)
    })
  });
</script>

{% endblock %}
