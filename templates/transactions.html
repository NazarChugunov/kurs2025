{% extends "base.html" %}
{% block title %}Транзакції{% endblock %}
{% block content %}

<!-- Заголовок сторінки -->
<h3 class="mb-4 text-light">Ваші транзакції</h3>

<!-- Форма додавання нової транзакції -->
<form method="POST" action="{{ url_for('add_transaction') }}" class="card border-0 shadow-sm p-3 mb-4">
  <div class="row g-3 align-items-end">

    <!-- Тип транзакції -->
    <div class="col-md-2">
      <label class="form-label text-light">Тип</label>
      <select name="type" class="form-select" required>
        <option value="income">Дохід</option>
        <option value="expense">Витрата</option>
      </select>
    </div>

    <!-- Категорія -->
    <div class="col-md-2">
      <label class="form-label text-light">Категорія</label>
      {% if categories %}
        <!-- Вибір із наявних категорій -->
        <select name="category_select" id="category_select" class="form-select">
          {% for c in categories %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
          <option value="">Своя категорія…</option>
        </select>
      {% else %}
        <!-- Якщо категорій ще немає — поле для вводу -->
        <input type="text" name="category" class="form-control" placeholder="Напр. Оренда" required>
      {% endif %}
    </div>

    <!-- Поле для власної категорії (з’являється при виборі “Своя категорія…”) -->
    {% if categories %}
    <div class="col-md-2 d-none" id="custom_category_wrap">
      <label class="form-label text-light">Своя категорія</label>
      <input type="text" name="category" class="form-control" placeholder="Введіть категорію">
    </div>
    {% endif %}

    <!-- Сума -->
    <div class="col-md-2">
      <label class="form-label text-light">Сума</label>
      <input type="number" step="0.01" min="0" name="amount" class="form-control" placeholder="0.00" required>
    </div>

    <!-- Метод оплати -->
    <div class="col-md-2">
      <label class="form-label text-light">Метод оплати</label>
      <select name="payment" class="form-select" required>
        <option value="Cash">Готівка</option>
        <option value="Card">Картка</option>
      </select>
    </div>

    <!-- Дата -->
    <div class="col-md-2">
      <label class="form-label text-light">Дата</label>
      <input type="date" name="date" value="{{ today }}" class="form-control" required>
    </div>

    <!-- Опис -->
    <div class="col-md-12">
      <label class="form-label text-light">Опис</label>
      <input type="text" name="description" class="form-control" placeholder="Коментар...">
    </div>

    <!-- Кнопка підтвердження -->
    <div class="col-md-12 text-end">
      <button type="submit" class="btn btn-primary px-4">Додати</button>
    </div>
  </div>
</form>

<!-- Таблиця історії транзакцій -->
<div class="card border-0 shadow-sm p-3">
  <h5 class="text-light mb-3">Історія транзакцій</h5>

  {% if transactions %}
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle">
      <thead>
        <tr>
          <th>Тип</th>
          <th>Категорія</th>
          <th>Сума</th>
          <th>Метод</th>
          <th>Дата</th>
          <th>Опис</th>
          <th></th>
        </tr>
      </thead>
      <tbody>

        <!-- Перебір усіх транзакцій -->
        {% for tid, t in transactions.items() %}
        <tr>
          <!-- Тип (дохід / витрата) -->
          <td>
            {% if t.type == 'income' %}
              <span class="badge bg-success">Дохід</span>
            {% else %}
              <span class="badge bg-danger">Витрата</span>
            {% endif %}
          </td>

          <!-- Категорія -->
          <td>{{ t.category }}</td>

          <!-- Сума -->
          <td>{{ currency }} {{ "%.2f"|format(t.amount|float) }}</td>

          <!-- Метод оплати -->
          <td>
            {% if t.payment_method == "Cash" %}
              Готівка
            {% elif t.payment_method == "Card" %}
              Картка
            {% else %}
              {{ t.payment_method }}
            {% endif %}
          </td>

          <!-- Дата -->
          <td>{{ t.date }}</td>

          <!-- Опис -->
          <td>{{ t.description or '-' }}</td>

          <!-- Видалення -->
          <td class="text-end">
            <form method="post" action="{{ url_for('delete_transaction', tid=tid) }}" onsubmit="return confirm('Видалити транзакцію?');">
              <button class="btn btn-sm btn-outline-danger" type="submit">×</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Якщо транзакцій немає -->
  {% else %}
    <p class="text-light mb-0">Поки що немає транзакцій.</p>
  {% endif %}
</div>

<!-- JS: показує поле для власної категорії -->
{% if categories %}
<script>
  const selectEl = document.getElementById('category_select');
  const customWrap = document.getElementById('custom_category_wrap');

  if (selectEl && customWrap) {
    selectEl.addEventListener('change', function() {
      if (this.value === "") {
        customWrap.classList.remove('d-none'); // показати поле
      } else {
        customWrap.classList.add('d-none');   // сховати поле
      }
    });
  }
</script>
{% endif %}

{% endblock %}
