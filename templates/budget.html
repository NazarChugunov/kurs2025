{% extends "base.html" %}
{% block title %}Бюджет{% endblock %}
{% block content %}

<!-- Заголовок сторінки -->
<h3 class="mb-3 text-light">Бюджет за категоріями</h3>

<!-- Форма додавання / встановлення бюджету -->
<div class="card mb-4 p-3 border-0 shadow-sm">
  <h6 class="text-light mb-3">Додати або встановити бюджет</h6>
  <form method="post" action="{{ url_for('save_budget_route') }}" class="row g-2">
    <div class="col-md-4">
      <label class="form-label text-light">Категорія</label>
      <input name="category" class="form-control" placeholder="Напр. Їжа" required>
    </div>
    <div class="col-md-3">
      <label class="form-label text-light">Сума</label>
      <input name="amount" type="number" step="0.01" min="0" class="form-control" placeholder="0.00" required>
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-primary w-100" type="submit">Зберегти</button>
    </div>
  </form>
</div>

<!-- Таблиця з поточними бюджетами -->
<div class="card border-0 shadow-sm p-3">
  <h5 class="text-light mb-3">Поточні бюджети</h5>

  <div class="table-responsive">
    <table class="table table-dark table-striped align-middle">
      <thead>
        <tr>
          <th>Категорія</th>
          <th>Ліміт</th>
          <th>Витрачено</th>
          <th>Залишок</th>
          <th>Статус</th>
          <th></th>
        </tr>
      </thead>
      <tbody>

        <!-- Якщо є дані про бюджети -->
        {% if budgets %}
          {% for cat, budget in budgets.items() %}
            {% set spent = spending_by_cat.get(cat, 0) %}
            {% set remaining = (budget|float) - (spent|float) %}
            {% set percent = (spent|float) / (budget|float) * 100 if budget|float > 0 else 0 %}

            <!-- Рядок із бюджетом -->
            <tr>
              <td>{{ cat }}</td>
              <td>{{ currency }} {{ "%.2f"|format(budget|float) }}</td>
              <td>{{ currency }} {{ "%.2f"|format(spent|float) }}</td>
              <td>{{ currency }} {{ "%.2f"|format(remaining) }}</td>
              <td>
                {% if percent <= 80 %}
                  <span class="badge bg-success">Нормально</span>
                {% elif percent <= 100 %}
                  <span class="badge bg-warning text-dark">Близько до ліміту</span>
                {% else %}
                  <span class="badge bg-danger">Перевищено</span>
                {% endif %}
              </td>

              <!-- Кнопки дій -->
              <td class="text-end">
                <div class="d-flex justify-content-end gap-2">
                  <!-- Редагування -->
                  <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#edit{{ loop.index }}">Редагувати</button>
                  <!-- Видалення -->
                  <form method="post" action="{{ url_for('delete_budget', cat=cat) }}" onsubmit="return confirm('Видалити категорію {{ cat }}?');">
                    <button class="btn btn-sm btn-outline-danger" type="submit">×</button>
                  </form>
                </div>
              </td>
            </tr>

            <!-- Прихована форма редагування -->
            <tr class="collapse" id="edit{{ loop.index }}">
              <td colspan="6">
                <form method="post" action="{{ url_for('update_budget') }}" class="row g-2 mt-2">
                  <input type="hidden" name="old_category" value="{{ cat }}">
                  <div class="col-md-4">
                    <label class="form-label text-light">Категорія</label>
                    <input name="category" class="form-control" value="{{ cat }}" required>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label text-light">Сума</label>
                    <input name="amount" type="number" step="0.01" min="0" class="form-control" value="{{ "%.2f"|format(budget|float) }}" required>
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" type="submit">Оновити</button>
                  </div>
                </form>
              </td>
            </tr>
          {% endfor %}

        <!-- Якщо бюджетів ще немає -->
        {% else %}
          <tr>
            <td colspan="6" class="text-light py-3">Бюджети ще не додані.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Пояснення щодо розрахунку -->
<p class="mt-3 text-secondary small">
  Витрати враховуються за поточний місяць. Щоб вони з’являлися у колонці “Витрачено”, додайте транзакції на сторінці
  <a href="{{ url_for('transactions_view') }}" class="link-light text-decoration-underline">“Транзакції”</a>.
</p>

{% endblock %}
